version: "3.9"

services:
  # Jupyter (Batch/EDA) - always available
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile.jupyter
    container_name: aerostream_jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./src:/app/src
      - ./data:/app/data
      - ./models:/app/models
      - ./chromadb_data:/app/chromadb_data
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-aerostream}
      - POSTGRES_USER=${POSTGRES_USER:-aerostream}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-aerostream123}
    depends_on:
      - postgres

  # Postgres for your project results (streaming predictions storage)
  postgres:
    image: postgres:15-alpine
    container_name: aerostream_postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-aerostream}
      POSTGRES_USER: ${POSTGRES_USER:-aerostream}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-aerostream123}
    ports:
      - "5432:5432"
    volumes:
      - aerostream_pg:/var/lib/postgresql/data

  # --- Airflow (Orchestration) ---
  # Separate DB for Airflow metadata (recommended)
  airflow-db:
    image: postgres:15-alpine
    container_name: aerostream_airflow_db
    environment:
      POSTGRES_DB: airflow
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
    volumes:
      - airflow_pg:/var/lib/postgresql/data

  airflow-init:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: aerostream_airflow_init
    depends_on:
      - airflow-db
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@airflow-db:5432/airflow
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-b2p6p0s3Q0g6QmY3c3ZyR0p6Qm5vV0V0dE5kV0l1Q3c9PQ==}
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username ${AIRFLOW_ADMIN_USER:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email ${AIRFLOW_ADMIN_EMAIL:-admin@example.com} || true
    restart: "no"

  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: aerostream_airflow_webserver
    depends_on:
      - airflow-db
      - airflow-init
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@airflow-db:5432/airflow
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-b2p6p0s3Q0g6QmY3c3ZyR0p6Qm5vV0V0dE5kV0l1Q3c9PQ==}
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_SECRET_KEY:-dev-secret-key}
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    ports:
      - "8080:8080"
    command: webserver

  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: aerostream_airflow_scheduler
    depends_on:
      - airflow-db
      - airflow-init
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@airflow-db:5432/airflow
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW_FERNET_KEY:-b2p6p0s3Q0g6QmY3c3ZyR0p6Qm5vV0V0dE5kV0l1Q3c9PQ==}
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - airflow_logs:/opt/airflow/logs
    command: scheduler

  # --- Optional app services (enable when you implement them) ---
  api:
    profiles: ["app"]
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: aerostream_api
    ports:
      - "8000:8000"
    environment:
      - MODEL_DIR=/app/models
    volumes:
      - ./models:/app/models
      - ./src:/app/src
      - ./api:/app/api
    depends_on:
      - postgres

  dashboard:
    profiles: ["app"]
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: aerostream_dashboard
    ports:
      - "8501:8501"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-aerostream}
      - POSTGRES_USER=${POSTGRES_USER:-aerostream}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-aerostream123}
      - API_URL=http://api:8000
    volumes:
      - ./dashboard:/app/dashboard
    depends_on:
      - postgres

volumes:
  aerostream_pg:
  airflow_pg:
  airflow_logs:
